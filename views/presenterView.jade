doctype html
html(lang='en')
  head
    title Chat
    style.
      #chat{
        height:0px;
      }
      #contentWrap{
        display:none;
      }
      #chatWrap{
        float: left;
        border: 1px #000 solid;
      }
  body
    #nickWrap
      p Enter a Username:
      p#nickError
      form#setNick
        input#nickname(size='35')
        input(type='submit')
    
    script(src='http://code.jquery.com/jquery-latest.min.js')
    script(src='/socket.io/socket.io.js')
    script.
      jQuery(function($){
        
        var socket = io.connect(); //CONNECT THE SOCKET
        var $nickForm = $('#setNick');
        var $nickError = $('#nickError');
        var $nickBox = $('#nickname');
        var $users = $('#users');
        var $messageForm = $('#send-message');
        var $messageBox = $('#message');
        var $chat = $('#chat');
        //var $frame = $('#frame');

        function linkadapter(url){
          $.getJSON('http://whateverorigin.org/get?url=' + encodeURIComponent(url) + '&callback=?', function(data){
              var html = ""+data.contents;

              /* Replace relative links to absolute ones */
              html = html.replace(new RegExp('(href|src)="/', 'g'),  '$1="'+url+'/');

              //$('#frame').contents().html(html);
              if ($('#frame').length > 0) {
                $('#frame').remove();
              }

              var newIframe = document.createElement('iframe');
              newIframe.setAttribute('id', 'frame');
              // Set attributes for iFrame (do whatever suits)
              newIframe.width = '100%'; newIframe.height = '100%';
              // This for the src makes it 'friendly'
              newIframe.src = 'about:blank'; 

              // Use whatever method is needed to insert the iframe where you want it 
              document.body.appendChild(newIframe);

              newIframe.contentWindow.document.open('text/html', 'replace');
              newIframe.contentWindow.document.write(html);
              newIframe.contentWindow.document.close();

              //change the height of the iframe
              var height = document.getElementById('frame').contentWindow.document.body.scrollHeight;
              document.getElementById('frame').height = height;
          });
        }
        function compdist(data, formvalue){
          if (formvalue === "CPU1"){
            linkadapter(data.link1);
          }
          else if (formvalue === "CPU2"){
            linkadapter(data.link2);
          }
          else if (formvalue === "CPU3"){
            linkadapter(data.link3);
          }
          else if (formvalue === "CPU4"){
            linkadapter(data.link4);
          }
        }
        function brandDistrib(){
          var formvalue = $nickBox.val();
          $.get("/api/v1/current_state", function (data){
            if (data.brandname === "Popeyes"){
              console.log("Made it to the get request to snag info from DB!");
              compdist(data, formvalue);
            }
            else if (data.brandname === 'Wellmark'){
              compdist(data, formvalue);
            }
            else if (data.brandname === 'GeneralMills'){
              compdist(data, formvalue);
            }
            else if (data.brandname === 'Keybank'){
              compdist(data, formvalue);
            }
            else if (data.brandname === 'Johnsonville'){
              compdist(data, formvalue);
            } 
          }, "json");
        }
        
        socket.on('stateupdate', function(data){
          console.log(data);
          brandDistrib();
        });

        $nickForm.submit(function(e){
          e.preventDefault();
          
          brandDistrib(); 

          socket.emit('new user', $nickBox.val(), function(data){
            if (data){
              $('#nickWrap').hide();
              $('#contentWrap').show();
            } else{
              $nickError.html("That username is already taken! Try again.");
            }
          });
          $nickBox.val('');
        });
        
        socket.on('usernames', function(data){
          var html = ' ';
          for(i=0; i < data.length; i++){
              html += data[i] + '<br/>';
          }
          $users.html(html);
        });
        
      });